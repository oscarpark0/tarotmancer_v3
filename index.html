<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>tarotmancer - Enter</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js"></script>
  <link rel="stylesheet" href="styles.css">
  <script src="starfield.js"></script>
  <link rel="prefetch" href="main.html" as="document">
  <link rel="preload" href="styles.css" as="style">
  <link rel="preload" href="starfield.js" as="script">
  <link rel="preload" href="tarot.js" as="script">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <style>
    body {
      margin: 0;
      overflow: hidden;
      background: #000;
      position: relative;
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
    }
    canvas {
      position: absolute;
      top: 0;
      left: 0;
      z-index: 1;
    }
    #tarot-container {
      z-index: 2;
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      perspective: 1000px;
      pointer-events: none; /* don't block the Enter button */
    }
    .tarot-card {
      position: absolute;
      width: 90px;
      height: 140px;
      opacity: 0;
      transform-style: preserve-3d;
      transform: scale(0) rotateY(180deg) translateZ(0);
      transition: none;
      border-radius: 6px;
      cursor: pointer;
      pointer-events: auto; /* keep cards hoverable/clickable */
    }
    .tarot-card.dealing {
      animation: dealAndFloat 1.5s cubic-bezier(0.22, 0.61, 0.36, 1) forwards;
    }
    .tarot-card.floating {
      opacity: 0.9;
      box-shadow: 0 0 15px rgba(147, 112, 219, 0.25),
                  0 0 30px rgba(147, 112, 219, 0.15),
                  0 0 60px rgba(147, 112, 219, 0.1);
      animation: gentleFloat 5s ease-in-out infinite, cardAura 3s infinite alternate;
    }
    .tarot-card:hover {
      transform: translateY(-20px) scale(1.1) translateZ(50px) !important;
      z-index: 1000 !important;
      box-shadow: 0 20px 40px rgba(147, 112, 219, 0.8),
                  0 40px 80px rgba(147, 112, 219, 0.4),
                  inset 0 0 30px rgba(255, 255, 255, 0.3);
    }
    .tarot-card img {
      width: 100%;
      height: 100%;
      border-radius: 6px;
      filter: saturate(1.2);
      backface-visibility: hidden;
    }

    @keyframes dealAndFloat {
      0% {
        opacity: 0;
        transform: translateX(50vw) translateY(-100vh) scale(0.9) rotateY(120deg) rotateZ(calc(var(--final-rotation) - 18deg));
      }
      50% {
        opacity: 0.5;
        transform: translateX(0) translateY(-16px) scale(0.95) rotateY(40deg) rotateZ(calc(var(--final-rotation) + 6deg));
      }
      100% {
        opacity: 0.9;
        transform: translateX(0) translateY(0) scale(var(--final-scale)) rotateY(0deg) rotateZ(var(--final-rotation));
      }
    }
    @keyframes cardAura {
      0% { 
        box-shadow: 0 0 15px rgba(147, 112, 219, 0.25),
                    0 0 30px rgba(147, 112, 219, 0.15),
                    0 0 60px rgba(147, 112, 219, 0.1);
      }
      100% { 
        box-shadow: 0 0 25px rgba(147, 112, 219, 0.3),
                    0 0 50px rgba(147, 112, 219, 0.2),
                    0 0 90px rgba(147, 112, 219, 0.15);
      }
    }
    @keyframes gentleFloat {
      0%, 100% { 
        transform: translateY(0) scale(var(--final-scale)) rotate(calc(var(--final-rotation) + var(--float-tilt, 0deg))); 
      }
      50% { 
        transform: translateY(-8px) scale(var(--final-scale)) rotate(calc(var(--final-rotation) - var(--float-tilt, 0deg))); 
      }
    }
    .enter-container {
        position: relative;
        z-index: 100;
        text-align: center;
    }
    #enterButton {
        background-color: rgba(0, 20, 0, 0.8);
        border: 2px solid #00FF00;
        padding: 15px 30px;
        font-size: 20px;
        font-weight: 600;
        border-radius: 6px;
        color: #00FF00;
        font-family: 'Courier New', Courier, monospace;
        cursor: pointer;
        transition: all 0.2s ease;
        text-transform: uppercase;
        letter-spacing: 2px;
        box-shadow: 0 0 10px rgba(0, 255, 0, 0.4);
    }
    #enterButton:hover {
        background-color: rgba(0, 255, 0, 0.15);
        box-shadow: 0 0 15px rgba(0, 255, 0, 0.6);
    }

    /* Transition overlay */
    #transition-overlay {
      position: fixed;
      inset: 0;
      z-index: 1000;
      pointer-events: none;
      opacity: 0;
      visibility: hidden;
      background:
        radial-gradient(120vh 120vh at 50% 50%, rgba(0,255,140,0.12), rgba(0,0,0,0) 60%),
        radial-gradient(200vh 140vh at 50% -20%, rgba(0,255,60,0.08), rgba(0,0,0,0) 55%),
        #000;
    }
    #transition-overlay::before {
      content: '';
      position: absolute; inset: 0;
      background: radial-gradient(60vh 60vh at 50% 50%, rgba(0,255,120,0.15), rgba(0,0,0,0) 55%);
      mix-blend-mode: screen;
      filter: blur(2px);
      opacity: 0;
    }
    #transition-overlay::after {
      content: '';
      position: absolute; inset: 0;
      background: radial-gradient(120vh 80vh at 50% 110%, rgba(0,0,0,0), rgba(0,0,0,0.85) 80%);
      opacity: 0;
    }
    .enter-transition {
      visibility: visible !important;
      animation: enterPortal 1200ms ease forwards;
    }
    .enter-transition::before { animation: enterGlow 1200ms ease forwards; }
    .enter-transition::after { animation: enterVignette 1200ms ease forwards; }

    @keyframes enterPortal {
      0% { opacity: 0; }
      10% { opacity: 1; }
      50% { opacity: 1; filter: brightness(1.2) saturate(1.2); }
      100% { opacity: 1; }
    }
    @keyframes enterGlow {
      0% { opacity: 0; transform: scale(0.8); }
      50% { opacity: 1; transform: scale(1.1); }
      100% { opacity: 0; transform: scale(1.3); }
    }
    @keyframes enterVignette {
      0% { opacity: 0; }
      60% { opacity: 0.5; }
      100% { opacity: 1; }
    }
    @media (prefers-reduced-motion: reduce) {
      .enter-transition,
      .enter-transition::before,
      .enter-transition::after {
        animation-duration: 0ms !important;
      }
    }
  </style>
</head>
<body>
  <div id="tarot-container"></div>

  <div id="transition-overlay" aria-hidden="true"></div>

  <div class="enter-container">
    <button id="enterButton">Enter</button>
  </div>

  <script>
    let tarotCards = [];
    async function loadIndexDeck() {
      try {
        const res = await fetch('tarot_data.json');
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const data = await res.json();
        tarotCards = Object.values(data);
        currentCardIndex = Math.floor(Math.random() * tarotCards.length);
      } catch (err) {
        console.error('Failed to load tarot_data.json for index page:', err);
        tarotCards = [
          { id: "m00", name: "The Fool", arcana: "major", description: "New beginnings", image_url: "https://ik.imagekit.io/tarotmancer/m00.webp" },
          { id: "m01", name: "The Magician", arcana: "major", description: "Manifestation", image_url: "https://ik.imagekit.io/tarotmancer/m01.webp" }
        ];
      }
    }

    let cardDealInterval;
    let currentCardIndex = 0;

    function getRandomInt(min, max) {
      return Math.floor(Math.random() * (max - min + 1)) + min;
    }
    
    function getRandomPosition() {
      const margin = 20;
      const cardW = 90;
      const cardH = 140;
      const minX = margin;
      const minY = margin;
      const maxX = Math.max(minX, window.innerWidth - cardW - margin);
      const maxY = Math.max(minY, window.innerHeight - cardH - margin);
      const x = getRandomInt(minX, maxX);
      const y = getRandomInt(minY, maxY);
      return { x, y };
    }
    
    // CSS starfield is initialized on DOMContentLoaded via initStarfield()
    
    function dealCard() {
      if (currentCardIndex >= tarotCards.length) {
        currentCardIndex = 0;
      }
      
      const cardData = tarotCards[currentCardIndex];
      const position = getRandomPosition();
      
      const cardDiv = document.createElement('div');
      cardDiv.className = 'tarot-card';
      cardDiv.dataset.cardId = cardData.id;
      
      const depth = getRandomInt(10, 50);
      cardDiv.style.zIndex = depth;
      
      const rotation = getRandomInt(-12, 12);
      const scale = 0.85 + (depth / 50) * 0.35;
      
      cardDiv.style.setProperty('--final-scale', scale);
      cardDiv.style.setProperty('--final-rotation', rotation + 'deg');
      const floatTilt = getRandomInt(1, 3);
      cardDiv.style.setProperty('--float-tilt', floatTilt + 'deg');
      
      cardDiv.style.left = position.x + 'px';
      cardDiv.style.top = position.y + 'px';
      
      const img = document.createElement('img');
      img.src = cardData.image_url;
      img.alt = cardData.name;
      img.title = `${cardData.name}: ${cardData.description}`;
      
      cardDiv.appendChild(img);
      document.getElementById('tarot-container').appendChild(cardDiv);
      
      setTimeout(() => {
        cardDiv.classList.add('dealing');
      }, 50);
      
      setTimeout(() => {
        cardDiv.classList.remove('dealing');
        cardDiv.classList.add('floating');
      }, 1500);
      
      const allCards = document.querySelectorAll('.tarot-card');
      if (allCards.length > 12) {
        const oldCard = allCards[0];
        
        oldCard.style.transition = 'opacity 0.8s ease, transform 0.8s ease, filter 0.8s ease';
        oldCard.style.opacity = '0';
        oldCard.style.transform = 'scale(0.3) rotateY(180deg)';
        oldCard.style.filter = 'brightness(2) blur(5px)';
        
        setTimeout(() => {
          if (oldCard.parentNode) {
            oldCard.remove();
          }
        }, 800);
      }
      
      currentCardIndex++;
    }

    function scheduleNextDeal() {
      const delay = getRandomInt(2000, 15000);
      cardDealInterval = setTimeout(() => {
        dealCard();
        scheduleNextDeal();
      }, delay);
    }

    document.addEventListener('DOMContentLoaded', async () => {
      // Initialize background starfield behind content
      initStarfield({ count: 260, zIndex: 0, maxSize: 2.4, minSize: 0.6, layers: 4 });
      await loadIndexDeck();
      dealCard();
      scheduleNextDeal();

      // Enter transition handler
      const btn = document.getElementById('enterButton');
      const overlay = document.getElementById('transition-overlay');
      btn.addEventListener('click', (e) => {
        e.preventDefault();
        btn.disabled = true;
        overlay.classList.add('enter-transition');

        const prefersReduced = window.matchMedia('(prefers-reduced-motion: reduce)').matches;
        const duration = prefersReduced ? 0 : 1200;
        setTimeout(() => {
          window.location.href = 'main.html';
        }, duration);
      });
    });
  </script>
</body>
</html>
